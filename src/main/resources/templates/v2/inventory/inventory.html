<!DOCTYPE html>
<div>
    <script>
        $(document).ready(function () {
            stockDrawer = new bootstrap.Offcanvas('#stockDrawer');
            // Load inventory data
            renderTable();
            // Search functionality
            $('#searchInput').on('input', function () {
                searchString = $(this).val().trim();
                currentPage = 1; // Reset to first page on new search
                renderTable();
            });

            // Context menu -> Update stock
            $('#ctxUpdateStock').on('click', function (e) {
                e.preventDefault();
                showStockDrawer();
            });

            // Context menu -> Create order
            $('#ctxCreateOrder').on('click', function (e) {
                e.preventDefault();
                hideContextMenu();
                if (!currentStock) return;
                renderCreateOrder(currentStock);
                showDrawerState('createOrder');
                stockDrawer.show();
            });

            // Context menu -> Delete row
            $('#ctxDeleteRow').on('click', function (e) {
                e.preventDefault();
                deleteStock();
            });

            document.onkeydown = function (e) {
                if (e.key === 'Escape' || e.key === 'Esc') {
                    hideContextMenu();
                }
            };

            $(document).on("click", function (e) {
                if (!$(e.target).closest('#stockContextMenu').length) {
                    hideContextMenu();
                }
            });
        });
    </script>
    <link href="/css/inventory.css" rel="stylesheet">
    <main class="px-md-4" style="margin-left: 13%;">
        <!-- Table Controls -->
        <div class="table-controls"
            style="display:flex; align-items:center; justify-content:space-between; margin-bottom:12px;">
            <div style="display:flex; align-items:center; gap:10px;">
                <button class="add-user-btn"
                    style="background:#2563eb;color:#fff;border:none;border-radius:10px;padding:0.45em 1em;font-size:0.98em;font-weight:600;display:flex;align-items:center;gap:6px;box-shadow:0 2px 8px rgba(37,99,235,0.08);cursor:pointer;transition:background 0.2s;">
                    <span style="font-size:1.1em;">+</span> Add User
                </button>
                <div style="position:relative;">
                    <input type="text" id="searchInput" placeholder="Search Item"
                        style="background:#f3f6fa;border:none;border-radius:10px;padding:0.45em 2em 0.45em 1.8em;padding-left: 30px;font-size:0.98em;color:#222;width:350px;outline:none;box-shadow:0 2px 8px rgba(0,0,0,0.03);">
                    <span
                        style="position:absolute;left:8px;top:50%;transform:translateY(-50%);color:#2563eb;font-size:1.08em;">
                        &#128269;
                    </span>
                </div>
            </div>
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3">
                <div></div>
                <div class="btn-toolbar mb-2 mb-md-0">
                    <div class="btn-group me-2">
                        <button type="button" class="btn btn-sm btn-outline-secondary">Share</button>
                        <button type="button" class="btn btn-sm btn-outline-secondary">Export</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="table-responsive">
            <!-- <table class="modern-table" id="paginatedTable" style="font-size:1em;"> -->
            <table class="inventory-table" style="font-size:1em;">
                <thead>
                    <tr>
                        <th style="display: none;">id</th>
                        <th>Box</th>
                        <th>Model</th>
                        <th>Remark</th>
                        <th>Part</th>
                        <th>Config</th>
                        <th>Det.</th>
                        <th class="text-right">Qty</th>
                        <th class="text-right">Sell P.</th>
                        <th>Vendor</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <!-- Table rows will be rendered by JS; update JS to match new columns if needed -->
                </tbody>
            </table>
            <div class="pagination-container">
                <div id="paginationDetails" class="pagination-details"></div>
                <div id="paginationControls" class="pagination-controls"></div>
            </div>
        </div>
    </main>
</div>
<!-- Right Drawer -->
<div class="offcanvas offcanvas-top" tabindex="-1" id="stockDrawer" style="text-align: center;"
    aria-labelledby="stockDrawerLabel">
    <div class="offcanvas-header border-bottom">
        <h5 class="offcanvas-title" id="stockDrawerLabel" style="font-size: 1.1rem;"></h5>
        <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>

    <div class="offcanvas-body d-flex justify-content-center">
        <div class="drawer-container">
            <!-- STATE: UPDATE STOCK -->
            <div id="drawerStateUpdateStock" class="d-none">
                <form id="formUpdateStock">
                    <div id="updateStockStaticInfo" class="mb-3">
                        <!-- read-only info filled by JS -->
                    </div>

                    <div class="row g-2 mb-3">
                        <div class="col-6">
                            <label class="form-label">Quantity</label>
                            <input type="number" class="form-control" name="qty" id="updQty">
                        </div>
                        <div class="col-6">
                            <label class="form-label">Sell Price</label>
                            <input type="number" class="form-control" name="sellPrice" id="updSellPrice">
                        </div>
                        <div class="col-6">
                            <label class="form-label">Buy Price</label>
                            <input type="number" class="form-control" name="buyPrice" id="updBuyPrice">
                        </div>
                        <div class="col-12">
                            <label class="form-label">Remark</label>
                            <input type="text" class="form-control" name="remarkText" id="updRemark">
                        </div>
                    </div>

                    <div class="d-flex justify-content-end gap-2">
                        <button type="button" class="btn btn-outline-secondary" id="btnCancelUpdateStock">
                            Cancel
                        </button>
                        <button type="submit" class="btn btn-primary">
                            Update
                        </button>
                    </div>
                </form>
            </div>

            <!-- STATE: CREATE ORDER -->
            <div id="drawerStateCreateOrder" class="d-none">
                <form id="formCreateOrder">
                    <div class="row g-2 mb-3">
                        <div class="col-12 d-flex justify-content-center">
                            <div class="order-card w-100">
                                <div class="input-group mb-0">
                                    <span class="input-group-text"
                                        style="width: 140px; text-align: right; display: block;">Challan
                                        No</span> <span class="form-control" id="challanNo"></span>
                                </div>
                                <div class="input-group mb-0">
                                    <span class="input-group-text"
                                        style="width: 140px; text-align: right; display: block;">Order
                                        Date</span> <input type="text" readonly class="form-control" id="datepicker">
                                </div>
                                <div class="input-group mb-0" style="display: none;">
                                    <span class="input-group-text">stockHeaderId</span> <input type="text"
                                        disabled="disabled" class="form-control" id="stockHeaderId">
                                </div>
                                <div class="input-group mb-0" style="display: none;">
                                    <span class="input-group-text">stockDetailId</span> <input type="text"
                                        disabled="disabled" class="form-control" id="stockDetailsId">
                                </div>
                                <div class="input-group mb-0">
                                    <span class="input-group-text"
                                        style="width: 140px; text-align: right; display: block;">Particulars</span>
                                    <span type="text" disabled="disabled" class="form-control text-break"
                                        id="itemDetailsForOrder"></span>
                                </div>
                                <div class="input-group mb-0">
                                    <span class="input-group-text"
                                        style="width: 140px; text-align: right; display: block;">Customer</span>
                                    <input class="form-control" autocomplete="off" list="customerData" accesskey="b"
                                        id="customer" placeholder="Search Customer...">
                                    <datalist id="customerData">
                                    </datalist>
                                    <button type="button" class="btn btn-secondary" tabindex="-1"
                                        data-bs-toggle="tooltip" data-bs-placement="top" id="showCustomerModalBtn"
                                        title="Add new Customer">+</button>
                                </div>

                                <div class="input-group mb-0">
                                    <span class="input-group-text"
                                        style="width: 140px; text-align: right; display: block;">Sell
                                        Price</span> <input type="text" style="max-width: 160px;" disabled="disabled"
                                        class="form-control" id="itemSellRate">
                                    <input type="number" style="max-width: 130px; display: block;" min="0" step=".01"
                                        class="form-control" id="newItemSellRate">
                                    <input type="text" value="" disabled="disabled" class="form-control">
                                </div>
                                <div class="input-group mb-0">
                                    <span class="input-group-text"
                                        style="width: 140px; text-align: right; display: block;">Quantity</span>
                                    <input type="number" style="max-width: 160px;" class="form-control" value="0"
                                        id="itemQuantity"> <span class="input-group-text"
                                        style="width: 130px; text-align: right; display: block;">Amount</span>
                                    <input type="number" min="0" step=".01" disabled="disabled" class="form-control"
                                        id="itemAmount">
                                </div>
                                <div class="input-group mb-0">
                                    <span class="input-group-text"
                                        style="width: 140px; text-align: right; display: block;">Courier
                                        Charges</span> <input type="number" value="0" min="0" class="form-control"
                                        style="max-width: 160px;" id="courierCharges"> <span class="input-group-text"
                                        style="width: 130px; text-align: right; display: block;">Order
                                        Amount</span> <input type="number" min="0" disabled="disabled"
                                        class="form-control" id="orderAmount">
                                </div>
                                <div class="input-group mb-0"></div>
                                <div class="input-group mb-0">
                                    <span class="input-group-text"
                                        style="width: 140px; text-align: right; display: block;">Payment
                                        Type</span> <select class="form-control" id="paymentType"
                                        style="max-width: 160px;">
                                        <option value="0">Select Payment Type</option>
                                        <option value="cash">Cash</option>
                                        <option value="vpp">VPP</option>
                                        <option value="paytm">Paytm</option>
                                        <option value="bank">Bank</option>
                                        <option value="pending">Pending</option>
                                    </select> <span class="input-group-text"
                                        style="width: 130px; text-align: right; display: block;">Account
                                        Name</span> <select class="form-control" id="orderRemark" disabled>
                                    </select>
                                    <button type="button" class="btn btn-secondary" tabindex="-1"
                                        data-bs-toggle="tooltip" data-bs-placement="top"
                                        id="showAccountForPaymentModalBtn" title="Add Account">+</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-end gap-2">
                        <button type="button" class="btn btn-outline-secondary" id="btnCancelCreateOrder">
                            Cancel
                        </button>
                        <button type="submit" class="btn btn-primary">
                            Create Order
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<script>

    function renderUpdateStock(stock) {
        $('#updateStockStaticInfo').html(`
      <div class="mb-2 fw-semibold">${stock.box} – ${stock.model}</div>
      <div class="small text-muted mb-2">
        ${stock.part} · ${stock.configuration} · Vendor: ${stock.vendor}
      </div>
    `);
        $('#updQty').val(stock.qty);
        $('#updSellPrice').val(stock.sellPrice);
        $('#updBuyPrice').val(stock.buyPrice);
        $('#updRemark').val(stock.remarkText || '');
    }

    function renderCreateOrder(stock) {

        // $('#ordQty').val(1);
        // $('#ordSellPrice').val(stock.sellPrice);
        // $('#ordCustomer').val('');
        // $('#ordNotes').val('');
    }

    // Overview buttons
    $('#btnDrawerUpdateStock').on('click', function () {
        if (!currentStock) return;
        renderUpdateStock(currentStock);
        showDrawerState('updateStock');
    });

    $('#btnDrawerCreateOrder').on('click', function () {
        if (!currentStock) return;
        renderCreateOrder(currentStock);
        showDrawerState('createOrder');
    });

    // Cancel buttons – back to overview
    $('#btnCancelUpdateStock').on('click', function () {
        showDrawerState('overview');
    });
    $('#btnCancelCreateOrder').on('click', function () {
        showDrawerState('overview');
    });

</script>
<div>
    <!-- Custom context menu for inventory row -->
    <ul id="stockContextMenu" class="dropdown-menu" style="position:absolute; display:none;font-size: 1em;">
        <li><a class="dropdown-item" href="#" id="ctxCreateOrder"><i class="bi bi-cart-plus me-2"></i>Create Order</a>
        </li>
        <li>
            <hr class="dropdown-divider">
        </li>
        <li><a class="dropdown-item" href="#" id="ctxUpdateStock"><i class="bi bi-pencil-square me-2"></i>Update
                Stock</a></li>
        <li><a class="dropdown-item" href="#" id="ctxAddStock"><i class="bi bi-bag-plus me-2"></i>Add Stock</a>
        </li>
        <li>
            <hr class="dropdown-divider">
        </li>
        <li><a class="dropdown-item text-danger" href="#" id="ctxDeleteRow"><i class="bi bi-trash me-2"></i>Delete
                Row</a></li>
    </ul>

</div>